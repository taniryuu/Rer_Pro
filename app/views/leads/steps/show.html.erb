<p id="notice"><%= notice %></p>

<h4><%= "#{@lead.customer_name} 様：「" %><%= link_to @lead.room_name, leads_path(room_searchword: @lead.room_name) %><%= "(#{@lead.room_num})」に入居予定" %></h4>
<h5>
  <%= "(担当：" %><%= link_to @user.name, leads_path(user_searchword: @user.id) %><%= "）" %>
  <%= "：あなたの案件です。" if @lead.user_id == current_user.id %>
  <%= link_to "：担当者を変更する", edit_user_id_lead_path(@lead) if current_user.superior? %>
</h5>

<h2><%= "現在：<STEP#{working_step_in(@lead).order}> #{working_step_in(@lead).name} (#{@lead.steps_rate}%済)" %></h2>

<% @steps.each do |step| %>
  <%= link_to "#{step.order}", step_path(step), class: "btn btn-info btn-lg" %>
<% end %>

<div>
  <h1 style="display:inline;"><%= "<STEP#{@step.order}> #{working_step_in(@lead).name}" %></h1>
  <h2 style="display:inline;"><%= "<<完了予定日：#{l(Time.parse(@step.scheduled_complete_date), format: :shortdate)}>>" %></h2>
  <a class="btn btn-default" data-toggle="collapse" href="#collapse-step-status-edit">
    編集
  </a>
</div>
<div id="collapse-step-status-edit" class="collapse">
  <div class="well">
    <!-- change step_status -->
    <% case @step.status %>
    <% when "not_yet" %>
      <%= render 'leads/step_statuses/start', step: @step, completed_id: nil, button_name: "開始" %>
      <%= render 'leads/step_statuses/cancel', step: @step %>
    <% when "inactive" %>
      <%= render 'leads/step_statuses/start', step: @step, completed_id: nil, button_name: "再開" %>
    <% when "in_progress" %>
      <button type="button" class="btn btn-info" data-toggle="modal" data-target="#step-complete" data-name="<%= @step.name %>" data-id="<%= @step.id %>">完了</button>
      <%= render 'leads/step_statuses/cancel', step: @step %>
    <% when "completed" %>
      <%= render 'leads/step_statuses/start', step: @step, completed_id: nil, button_name: "再開" %>
    <% when "template" %>
      <button type="button" class="btn btn-info">このテンプレートを使用して新規作成</button>
    <% end %>
    <h5 style="display:inline;"><%= link_to '直接編集', edit_step_path(@step) %></h5>
  </div>
</div>

<br>////////////////////////////////////////////////////////////////////////////////////////////////////////////<br>
ここにタスク一覧（TODOリスト～削除済リスト）が入ります。

<br>////////////////////////////////////////////////////////////////////////////////////////////////////////////<br>



<br>////////////////////////////////////////////////////////////////////////////////////////////////////////////<br>
以下はメモです。（最終プルリク上げる前に削除）
<div class="row">
  <div class="col-md-12 col-md-offset-1">
    <table id="table-lead-index-show">
      <thead>
        <tr>
          <th colspan="1">申込日</th>
          <th colspan="1">最後に進捗を完了した日</th>
          <th colspan="1">現在の進捗（進捗率）</th>
          <th colspan="1">入居予定日</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><%= l(Time.parse(@lead.created_date), format: :shortdate) %></td>
          <td><%= l(Time.parse(last_update_date(@lead)), format: :shortdate) %></td>
          <td>
            <%= latest_step_in(@lead).name %>
            <%= "(#{@lead.steps_rate}%)" %>
          </td>
          <td><%= l(Time.parse(@lead.scheduled_resident_date), format: :shortdate) %></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<%= link_to '編集', edit_lead_path(@lead), class: "btn btn-primary btn-sm" if @lead.user_id == current_user.id %>



<%= "あなたの案件です。" if @lead.user_id == current_user.id %>
<%= @lead.customer_name %>様→
<%= @lead.room_name %><%= @lead.room_num %>号室
（担当：<%= link_to "#{@user.name}", user_path(@user) %>）
<p>
  <strong>入居予定日:</strong>
  <%= @lead.scheduled_resident_date %>
</p>

<p>
  <strong>入金予定日:</strong>
  <%= @lead.scheduled_payment_date %>
</p>

<p>
  <strong>契約予定日:</strong>
  <%= @lead.scheduled_contract_date %>
</p>


<%= link_to "担当者を変更する", edit_user_id_lead_path(@lead) if current_user.superior? %>


<%= link_to '本案件のメインページへ', lead_steps_path(@lead), class: "btn btn-primary btn-sm" %> |
<%= link_to 'Edit', edit_lead_path(@lead) %> |
<%= link_to 'Back', leads_path %>



<br>
<br>
<br>
<br>
////////////////////////////////////////////////////////////////////////////////////////////////////////////<br>



<p>
  <strong>Lead:</strong>
  <%= @step.lead_id %>
</p>

<p>
  <strong>Name:</strong>
  <%= @step.name %>
</p>

<p>
  <strong>Memo:</strong>
  <%= @step.memo %>
</p>

<p>
  <strong>Status:</strong>
  <%= @step.status %>
</p>

<p>
  <strong>Order:</strong>
  <%= @step.order %>
</p>

<p>
  <strong>Scheduled complete date:</strong>
  <%= @step.scheduled_complete_date %>
</p>

<p>
  <strong>Completed date:</strong>
  <%= @step.completed_date %>
</p>

<p>
  <strong>Canceled date:</strong>
  <%= @step.canceled_date %>
</p>

<p>
  <strong>Completed tasks rate:</strong>
  <%= @step.completed_tasks_rate %>
</p>

<%= link_to 'Task-index', step_tasks_path(@step) %> |
<%= link_to 'Edit', edit_step_path(@step) %> |
<%= link_to 'Back', lead_steps_path(@lead) %>


<br>
<br>




<!-- Modal -->
<div class="modal fade" id="step-complete" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="step-completeLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="step-completeLabel"><span class="step-name"></span>を完了します。次の操作を選択してください。</h5>
        <button type="button" class="close pull-right" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        進捗一覧<br>
        <table class="table table-hover" id="table-shops">
          <tbody>
            <% @steps_except_self.each do |step| %>
              <tr>
                <td>Step<%= step.order %></td>
                <% if step.status == "not_yet" %>
                  <td><%= render 'leads/step_statuses/start', step: step, completed_id: @step.id, button_name: "完了予定日を設定して開始する" %></td>
                <% elsif step.status == "inactive" %>
                  <td>
                    <p>
                      <a class="btn btn-default btn-xs" data-toggle="collapse" href="#collapseStep<%= step.id %>">
                    	  <%= "(#{step.status_i18n})" %>
                      </a>
                    </p>
                    <div id="collapseStep<%= step.id %>" class="collapse">
                    	<div class="well">
                        <%= render 'leads/step_statuses/start', step: step, completed_id: @step.id, button_name: "完了予定日を再設定して再開する" %>
                    	</div>
                    </div>
                  </td>
                <% elsif step.status == "in_progress" %>
                  <td><%= link_to "＜#{step.status_i18n}＞#{step.name}を継続", complete_step_path(step, @step), method: :patch, class: "btn btn-info btn-sm" %></td>
                <% elsif step.status == "completed" %>
                  <td>
                    <p>
                      <a class="btn btn-default btn-xs" data-toggle="collapse" href="#collapseStep<%= step.id %>">
                    	  <%= step.status_i18n %>
                      </a>
                    </p>
                    <div id="collapseStep<%= step.id %>" class="collapse">
                    	<div class="well">
                        <%= render 'leads/step_statuses/start', step: step, completed_id: @step.id, button_name: "完了予定日を再設定して再開する" %>
                    	</div>
                    </div>
                  </td>
                <% end %>
                <td><%= link_to "詳細確認", step_path(step), target: :_blank %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
        <% if @steps_from_now_on.present? %>
          <%= link_to "新しく作成する場合はこちら", new_lead_step_path(@lead, completed_id: @step.id), class: "pull-right" %>
        <% else %>
          <%= link_to "新たに次の進捗を作成して進む", new_lead_step_path(@lead, completed_id: @step.id), class: "btn btn-primary btn-lg" %>
          <br><br>
          <%= link_to "全ての進捗を完了＋案件自体を完了にする", complete_step_path(@step, @step), method: :patch, 
            data: { confirm: '本案件を全て完了とします。本当によろしいですか？（終了済の扱いになります。）' }, class: "btn btn-info btn-lg pull-right" %>
        <% end %>
      </div>
      <div class="modal-footer">
        <%= "* まだこの時点では#{@step.name}は完了していません。" %>
      </div>
    </div>
  </div>
</div>

<script> 
  $('#step-complete').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget);
    var id = button.data('id');
    var name = button.data('name');
    
    var modal = $(this);
    modal.find('.step-id').val(id);
    modal.find('.step-name').text(name);
  });
</script>

